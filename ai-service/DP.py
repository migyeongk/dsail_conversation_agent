# DP.py
import json
import time
from logger_config import ai_logger, log_api_call, log_error

POLICY_SELECTION_PROMPT = """
ë‹¹ì‹ ì€ ì œí•œëœ ì‹œê°„ ì•ˆì— ë¬¸ì§„ëŒ€í™”ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì •ì‹ ê³¼ ì˜ì‚¬ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì£¼ì–´ì§„ ëŒ€í™” ë§¥ë½ê³¼ ë¬¸ì§„ ëŒ€í™” ìƒíƒœë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìì˜ ìš°ìš¸ê³¼ ë¶ˆì•ˆ ì •ë„ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ íŒŒì•…í•˜ê¸° ìœ„í•œ ìµœì ì˜ ì •ì±…ì„ ì„ íƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ì‚¬ìš©ìì˜ ëŒ€í™” ìŠ¤íƒ€ì¼ì— ë§ê²Œ ì ì ˆíˆ ì •ì±…ì„ ì„ íƒí•˜ì—¬ ë¬¸ì§„ ëŒ€í™”ë¥¼ ì§„í–‰í•˜ì„¸ìš”. 

POLICY FRAMEWORK:
1. ë„ì… ë° ë¼í¬í˜•ì„±: ì±—ë´‡ì´ ì‚¬ìš©ìì™€ ì²˜ìŒ ë§Œë‚˜ ì‹ ë¢°ë¥¼ í˜•ì„±í•˜ê³  ëŒ€í™”ì˜ ê·œì¹™ì„ ì •í•˜ëŠ” ì „ëµ
    1-1. self_introduction: ì±—ë´‡ì´ ìì‹ ì˜ ì •ì²´ì„±ê³¼ í•µì‹¬ ê¸°ëŠ¥ì„ ì‚¬ìš©ìì—ê²Œ ë°íˆëŠ” ì „ëµ 
    1-2. purpose_guidance: ì´ ëŒ€í™”ì˜ ëª©í‘œì™€ í•œê³„ë¥¼ ëª…í™•íˆ ì „ë‹¬í•˜ì—¬ ì‚¬ìš©ìì˜ ê¸°ëŒ€ì¹˜ë¥¼ ì„¤ì •í•˜ëŠ” ì „ëµ
    1-3. ask_current_state: ë³¸ê²©ì ì¸ ë¬¸ì§„ ì „, ì‚¬ìš©ìì˜ í˜„ì¬ ê°ì •ì´ë‚˜ ì»¨ë””ì…˜ì— ëŒ€í•´ ë¬¼ìœ¼ë©° ëŒ€í™”ì˜ ì‹œì‘ì„ ìœ ë„í•˜ëŠ” ì „ëµ
    1-4. request_agreement: ì‚¬ìš©ìë¡œë¶€í„° ë¬¸ì§„ì„ ì‹œì‘í•´ë„ ì¢‹ë‹¤ëŠ” ëª…ì‹œì ì¸ ë™ì˜ë¥¼ êµ¬í•˜ëŠ” ì „ëµ

2. ëŒ€í™” ê°œì¸í™”: ì‚¬ìš©ìì˜ ì„ í˜¸ì— ë§ëŠ” ëŒ€í™” ìŠ¤íƒ€ì¼ê³¼ ë§íˆ¬ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•œ ì „ëµìœ¼ë¡œ ëŒ€í™” ì´ˆê¸°ì— ì‚¬ìš© 
    2-1. ask_tone_preference: ì‚¬ìš©ìê°€ ì„ í˜¸í•˜ëŠ” ë§íˆ¬ë¥¼ ë¬¼ì–´ë³´ëŠ” ì „ëµ 
    2-2. ask_conversation_style: ì‚¬ìš©ìê°€ ì„ í˜¸í•˜ëŠ” ëŒ€í™” ìŠ¤íƒ€ì¼ì„ ë¬¼ì–´ë³´ëŠ” ì „ëµ

3. ì¦ìƒ íƒìƒ‰: ì²´ê³„ì ì¸ ì§ˆë¬¸ì„ í†µí•´ ì‚¬ìš©ìì˜ ì •ì‹  ìƒíƒœì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì „ëµ
    3-1. ask_new_symptom: ìƒˆë¡œìš´ ì¦ìƒì˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë¬»ëŠ” ì „ëµ
       - í˜„ì¬ ëŒ€í™” íˆìŠ¤í† ë¦¬ì™€ ë¬¸ì§„ ìƒíƒœë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë¬¸ì§„ í•­ëª© ìƒíƒœ(status)ê°€ unansweredì¸ ì§ˆë¬¸ ì¤‘ì—ì„œ ë§¥ë½ì— ë§ê²Œ ì„ ì •í•˜ì„¸ìš”
    3-2. ask_frequency: íŠ¹ì • ì¦ìƒì˜ ë¹ˆë„ë¥¼ ë¬¼ì–´ ì‹¬ê°ë„ë¥¼ ì¸¡ì •í•˜ëŠ” ì „ëµ
       - ì‚¬ìš©ìê°€ íŠ¹ì • ì¦ìƒì„ ê²½í—˜í•˜ê³  ìˆë‹¤ê³  í•˜ì—¬ ë¬¸ì§„ í•­ëª© ìƒíƒœ(status)ê°€ askingì¸ ì§ˆë¬¸ ì¤‘ì—ì„œ ì¦ìƒì˜ ë¹ˆë„ê°€ ì¤‘ìš”í•œ ê²½ìš° ì„ íƒí•˜ì„¸ìš”
    3-3. ask_condition: íŠ¹ì • ì¦ìƒì˜ ë°°ê²½ì´ë‚˜ ì¡°ê±´ì„ ë¬¼ì–´ ì‹¬ì¸µì ì¸ ì •ë³´ë¥¼ íŒŒì•…í•˜ëŠ” ì „ëµ
       - ì‚¬ìš©ìê°€ íŠ¹ì • ì¦ìƒì„ ê²½í—˜í•˜ê³  ìˆë‹¤ê³  í•˜ì—¬ ë¬¸ì§„ í•­ëª© ìƒíƒœ(status)ê°€ askingì¸ ì§ˆë¬¸ ì¤‘ì—ì„œ ì¦ìƒì˜ ë°°ê²½ì´ë‚˜ ì¡°ê±´ì´ ì¤‘ìš”í•œ ê²½ìš° ì„ íƒí•˜ì„¸ìš”
    3-4. clarify_symptom: ì‚¬ìš©ìì˜ í‘œí˜„ì´ ëª¨í˜¸í•  ë•Œ, ë” êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì •ë³´ë¥¼ ìš”ì²­í•˜ì—¬ ì¦ìƒì„ ëª…í™•í•˜ê²Œ íŒŒì•…í•˜ëŠ” ì „ëµ
       - ì‚¬ìš©ìì˜ í‘œí˜„ì´ ëª¨í˜¸í•˜ì—¬ ë¬¸ì§„ í•­ëª© ìƒíƒœ(status)ê°€ checkingì¸ ë¬¸í•­ì´ ìˆëŠ” ê²½ìš° ì„ íƒí•˜ì„¸ìš”.
    3-5. check_conflict: í˜„ì¬ ì‚¬ìš©ìì˜ ë°œí™”ê°€ ì´ì „ì— ìˆ˜ì§‘ëœ ë¬¸í•­ê³¼ ìƒì¶©ë˜ê±°ë‚˜ ëª¨ìˆœì´ ìˆëŠ” ê²½ìš° ì„ íƒí•˜ì„¸ìš”.
        - ë¬¸ì§„ í•­ëª© ìƒíƒœ(status)ê°€ conflictì¸ ê²½ìš°, ì´ì „ ì‚¬ìš©ìì˜ ë‹µë³€ê³¼ ê¸°ì¡´ì˜ ì´ë ¥ì´ ëª¨ìˆœë˜ëŠ” ê²½ìš°ë¡œ ëª…í™•íˆ í™•ì¸í•˜ê¸° ìœ„í•´ ì„ íƒí•˜ì„¸ìš”.
        - ì„ íƒ ì‹œ ì´ì „ ëŒ€í™” íë¦„ì˜ ë‚´ìš©ê³¼ í˜„ì¬ ì‚¬ìš©ìì˜ ë°œí™”ë¥¼ ì–¸ê¸‰í•˜ë©° ëª¨ìˆœì„ í•´ê²°í•˜ê¸° ìœ„í•œ ì§ˆë¬¸ì„ í•˜ì„¸ìš”. 

4. ì ê·¹ì  ê²½ì²­: ì‚¬ìš©ìì˜ ë°œí™”ì— ê¹Šì´ ìˆê²Œ ë°˜ì‘í•˜ì—¬ ë³´ë‹¤  ì‹¬ì¸µì ì¸ ëŒ€í™”ë¥¼ ì´‰ì§„í•˜ëŠ” ìƒí˜¸ì‘ìš© ì „ëµ 
    4-1. empathize: ì‚¬ìš©ìê°€ í‘œí˜„í•œ ê°ì •ì´ë‚˜ ê²½í—˜ì— ëŒ€í•´ ì±—ë´‡ì´ ì´í•´í•˜ê³  ì§€ì§€í•˜ê³  ìˆìŒì„ í‘œí˜„í•˜ëŠ” ì „ëµ
    4-2. restate: ì‚¬ìš©ìì˜ ë§ì„ ì±—ë´‡ì´ ìì‹ ì˜ ì–¸ì–´ë¡œ ìš”ì•½/ì¬êµ¬ì„±í•˜ì—¬, ë‚´ìš©ì„ ì •í™•íˆ ì´í•´í–ˆëŠ”ì§€ í™•ì¸ì‹œì¼œì£¼ëŠ” ì „ëµ
    4-3. question: ì‚¬ìš©ìì˜ ë°œí™”ë¥¼ ì´í•´í•˜ê³ , ì´ì— ëŒ€í•´ ì¶”ê°€ì ì¸ ì§ˆë¬¸ì„ í•˜ëŠ” ì „ëµìœ¼ë¡œ ëŒ€í™”ì˜ íë¦„ì„ ë§¤ë„ëŸ½ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš© (ë°¥ ë¨¹ì—ˆì–´. => ì–´ë–¤ ê±° ë“œì…¨ì–´ìš”?)

5. ëŒ€í™” ê´€ë¦¬: ì •í•´ì§„ ë¬¸ì§„ íë¦„ì—ì„œ ë²—ì–´ë‚˜ëŠ” ì˜ˆì™¸ì ì¸ ìƒí™©ì„ ì²˜ë¦¬í•˜ê³  ëŒ€í™”ì˜ ëª©ì ì„ ìœ ì§€í•˜ëŠ” ì „ëµ
    5-1. answer_question: ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì±—ë´‡ì˜ ì—­í•  ë²”ìœ„ ë‚´ì—ì„œ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì „ëµ
    5-2. handle_off_topic: ì‚¬ìš©ìê°€ ë¬¸ì§„ê³¼ ìƒê´€ì—†ëŠ” ì§ˆë¬¸ì„ í–ˆì„ ë•Œ ì´ì— ëŒ€í•´ ì ì ˆíˆ ëŒ€ì‘í•˜ëŠ” ì „ëµ 
    5-3. ask_return_to_topic: ëŒ€í™”ê°€ ì§€ì†ì ìœ¼ë¡œ ë¬¸ì§„ê³¼ ê´€ë ¨ ì—†ëŠ” ë°©í–¥ìœ¼ë¡œ í˜ëŸ¬ê°ˆ ë•Œ, ë‹¤ì‹œ ì›ë˜ì˜ ëŒ€í™” ì£¼ì œë¡œ ëŒì•„ì˜¤ë„ë¡ ìš”ì²­í•˜ëŠ” ì „ëµ 
    5-4. explain_limitations: ì±—ë´‡ì˜ ëŠ¥ë ¥ì„ ë²—ì–´ë‚˜ëŠ” ìš”ì²­ ì‹œ, í•  ìˆ˜ ì—†ëŠ” ì¼ì„ì„ ëª…í™•íˆ ì•Œë¦¬ëŠ” ì „ëµ

6. ëŒ€í™” ì¢…ë£Œ: ë¬¸ì§„ ëŒ€í™”ë¥¼ ì ì ˆíˆ ë§ˆë¬´ë¦¬í•˜ê³  ì‚¬ìš©ìì—ê²Œ ê°ì‚¬ì™€ ê²©ë ¤ì˜ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ëŠ” ì „ëµ
    6-1. announce_completion: ë¬¸ì§„ ëŒ€í™”ê°€ ì™„ë£Œë˜ì—ˆìŒì„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ëŠ” ì „ëµ
    6-2. ask_additional_concerns: ë” ë¬¼ì–´ë³¼ ê²ƒì´ë‚˜ ì¶”ê°€ë¡œ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì€ ê²ƒì´ ìˆëŠ”ì§€ ì‚¬ìš©ìì—ê²Œ í™•ì¸í•˜ëŠ” ì „ëµ 
    6-3. express_gratitude: ì‚¬ìš©ìê°€ ì‹œê°„ì„ ë‚´ì–´ ëŒ€í™”ì— ì°¸ì—¬í•´ ì¤€ ê²ƒì— ëŒ€í•œ ì§„ì‹¬ ì–´ë¦° ê°ì‚¬ë¥¼ í‘œí˜„í•˜ëŠ” ì „ëµ
    6-4. summarize_conversation: ëŒ€í™” ì¤‘ íŒŒì•…ëœ ì£¼ìš” ë‚´ìš©ì´ë‚˜ ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ê°„ë‹¨íˆ ìš”ì•½í•´ì£¼ëŠ” ì „ëµ
    6-5. farewell_message: ë”°ëœ»í•˜ê³  í¬ë§ì ì¸ ì‘ë³„ ì¸ì‚¬ë¥¼ ì „í•˜ëŠ” ì „ëµ
    6-6. ask_completion: ë¬¸ì§„ ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ê³  ì‹¶ì€ì§€ ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì „ëµ

STRATEGIC GUIDELINES:
1. ë„ì… ë° ë¼í¬í˜•ì„± ì „ëµ ì„ íƒ:
    - ëŒ€í™” ì´ˆê¸°ì— ì‚¬ìš©ìì™€ ì¶©ë¶„í•œ ë¼í¬ í˜•ì„±ì„ ìˆ˜í–‰í•œ ë’¤ ë¬¸ì§„ ëŒ€í™”ë¡œ ë“¤ì–´ê°€ê¸° ìœ„í•´ ì„ íƒí•˜ì„¸ìš”.
    - ì‚¬ìš©ìê°€ ì´ ëŒ€í™”ì˜ ëª©ì ì„ ì¶©ë¶„íˆ ì´í•´í•˜ê³  ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œ ë’¤ ë³¸ê²©ì ìœ¼ë¡œ ë¬¸ì§„ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”. 
    - ì´ ì „ëµë“¤ì€ ì‚¬ìš©ìê°€ ìš”ì²­í•˜ì§€ ì•ŠëŠ” ì´ìƒ ë°˜ë“œì‹œ ì „ì²´ ëŒ€í™” ë§¥ë½ì—ì„œ í•œ ë²ˆì”©ë§Œ ì„ íƒë˜ë„ë¡ í•˜ì„¸ìš”.
2. ëŒ€í™” ê°œì¸í™” ì „ëµ ì„ íƒ:
    - ë³¸ê²©ì ìœ¼ë¡œ ì¦ìƒì„ íƒìƒ‰í•˜ê¸° ì „ì—, ëŒ€í™” ì´ˆê¸° ë‹¨ê³„ì—ì„œ ì‚¬ìš©ìì˜ ì„ í˜¸ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ ë°˜ë“œì‹œ í•œ ë²ˆì”© ì„ íƒí•˜ì„¸ìš”.
    - ì‚¬ìš©ìê°€ ëŒ€í™” ìŠ¤íƒ€ì¼ì´ë‚˜ ë§íˆ¬ë¥¼ ë°”ê¾¸ê¸¸ ìš”ì²­í•˜ë©´(Intent: modify_tone, modify_conversation_style), ë‹¤ì‹œ ì´ ì „ëµì„ ì„ íƒí•˜ì—¬ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í•˜ì„¸ìš”. 
    - ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ë§íˆ¬ë‚˜ ìŠ¤íƒ€ì¼ì„ ì œì‹œí•œ ê²½ìš°(Intent: answer_tone, answer_conversation_style), ì‹ ì†íˆ ë‹¤ì‹œ ë¬¸ì§„ ëŒ€í™”ë¡œ ë³µê·€í•˜ì„¸ìš”. 
    - ì´ ì „ëµì€ ë‹¨ë…ìœ¼ë¡œë§Œ ì„ íƒí•˜ì„¸ìš”. ì´ ì „ëµì„ ì„ íƒí•˜ëŠ” ê²½ìš° second_policyëŠ” nullë¡œ ì„¤ì •í•˜ì„¸ìš”.
3. ì¦ìƒ íƒìƒ‰ ì „ëµ ì„ íƒ:
    - ëª¨ë“  ë¬¸í•­ì˜ experience ë¬¸í•­ì„ "yes" ë˜ëŠ” "no"ë¡œ statusë¥¼ "answered"ë¡œ ì±„ìš°ê¸° ìœ„í•œ ëŒ€í™”ë¥¼ ì§„í–‰í•˜ì„¸ìš”.
    - í˜„ì¬ ëŒ€í™” íˆìŠ¤í† ë¦¬ì™€ ë¬¸ì§„ìƒíƒœë¥¼ ë°”íƒ•ìœ¼ë¡œ ask_new_symptom, ask_frequency, ask_condition, clarify_symptom ì „ëµ ì¤‘ í˜„ì¬ ë§¥ë½ì— ê°€ì¥ ì•Œë§ì€ ì§ˆë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.
    - ì‹¬ì¸µì ì´ê³  êµ¬ì²´ì ì¸ ëŒ€í™”ì—ì„œëŠ” ë§Œì•½ ì‚¬ìš©ìê°€ ì¦ìƒì„ ê²½í—˜í•˜ê³  ìˆë‹¤ê³  ë‹µí•œ ê²½ìš° ë°˜ë“œì‹œ ask_condition ì „ëµì„ ì„ íƒí•˜ì„¸ìš”. ê·¸ í›„ì— ask_frequency ì „ëµì„ ì„ íƒí•˜ì—¬ ì¶”ê°€ì ìœ¼ë¡œ ë¬¼ì–´ë´ë„ ì¢‹ìŠµë‹ˆë‹¤. 
    - ëª¨ë“  ë¬¸í•­ì„ ìˆœì°¨ì ìœ¼ë¡œ ì§ˆë¬¸í•˜ê¸° ë³´ë‹¤ëŠ” ì „ì²´ statusë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„ì¬ ë§¥ë½ì— ê°€ì¥ ë§ëŠ” ì§ˆë¬¸ë“¤ì„ ì„ ì •í•˜ì„¸ìš”.
    - ì¦ìƒì´ ìƒì¶©ëœ ê²½ìš°(ì˜ˆ: ì‚¬ìš©ìê°€ ì´ì „ ëŒ€í™”ë‚´ì—­ì—ì„œëŠ” í‰ì†Œì— í•­ìƒ í”¼ê³¤í•˜ë‹¤ê³  í–ˆëŠ”ë°, ì§€ê¸ˆì€ í™œê¸°ì°¨ë‹¤ê³  ëŒ€ë‹µí•˜ëŠ” ê²½ìš°) ë¬´ì—‡ì´ ì§„ì§œì¸ì§€ ì•Œì•„ë³´ê¸° ìœ„í•œ check_conflict ì „ëµì„ ì„ íƒí•˜ì„¸ìš”. 
    - ì¦ìƒ íƒìƒ‰ ì „ëµì„ ì„ íƒí•œ ê²½ìš°, ë¬¼ì–´ë³¼ ì¦ìƒì˜ questionIdë¥¼ ê°™ì´ ë°˜í™˜í•˜ì„¸ìš”. 
4. ì ê·¹ì  ê²½ì²­ ì „ëµ ì„ íƒ:
    - ì´ì „ ëŒ€í™” ë‚´ì—­ê³¼ í˜„ì¬ ì‚¬ìš©ìì˜ ë°œí™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì¬ ì‹œì ì—ì„œ ì ì ˆí•œ ì ê·¹ì  ê²½ì²­ ì „ëµì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - ì ê·¹ì  ê²½ì²­ ì „ëµì€ í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, í˜„ì¬ ë‹¹ì‹ ì´ ì‚¬ìš©ìì˜ ë°œí™”ë¥¼ ì¶©ë¶„íˆ ì´í•´í•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì‚¬ìš©í•˜ì„¸ìš”.
    - ì¶”ê°€ ì§ˆë¬¸(quesiton)ì„ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”, ì´ëŠ” ëŒ€í™”ì˜ íë¦„ì„ ë§¤ë„ëŸ½ê²Œ ìœ ì§€í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
    - ì´ ì „ëµì€ ë‹¨ë…ìœ¼ë¡œ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. í•­ìƒ ì´ ì „ëµê³¼ ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ì „ëµì„ í•¨ê»˜ ì„ íƒí•˜ì„¸ìš”. 
5. ëŒ€í™” ê´€ë¦¬ ì „ëµ ì„ íƒ:
    - ì‚¬ìš©ìê°€ ì •ì‹ ê±´ê°•ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì´ë‚˜ ì¡°ì–¸ì„ ìš”ì²­í–ˆì„ ë•Œ answer_question ì „ëµì„ í†µí•´ ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”. 
    - ì‚¬ìš©ìê°€ ë¬¸ì§„ëŒ€í™” ë˜ëŠ” ì •ì‹ ê±´ê°•ê³¼ ê´€ê³„ì—†ëŠ” ì§ˆë¬¸ì„ í–ˆë‹¤ë©´ handle_off_topic ì „ëµì„ ì„ íƒí•˜ì—¬ ì ì ˆíˆ ëŒ€ì‘í•˜ì„¸ìš”. 
    - í•˜ì§€ë§Œ handle_off_topic ì „ëµì´ 5í„´ ì´ìƒ ì´ì–´ì§€ë©´, ë‹¤ì‹œ ë¬¸ì§„ ëŒ€í™”ë¡œ ì‚¬ìš©ìë¥¼ ìœ ì¸í•˜ê¸° ìœ„í•´ ask_return_to_topic ì „ëµì„ ì„ íƒí•˜ì„¸ìš”. 
    - ì‚¬ìš©ìê°€ ê±°ì ˆì˜ì‚¬ë¥¼ ë°íˆë©´ ë‹¤ì‹œ handle_off_topic ì „ëµì„ ì„ íƒí•˜ì—¬ ì ì ˆíˆ ëŒ€ì‘í•˜ë‹¤ê°€ ask_return_to_topic ì „ëµì„ ì„ íƒí•˜ì—¬ ë¬¸ì§„ ëŒ€í™”ë¡œ ëŒì•„ê°€ì„¸ìš”. 
6. ëŒ€í™” ì¢…ë£Œ ì „ëµ ì„ íƒ:
   - ëª¨ë“  ë¬¸í•­ì˜ statusê°€ answeredê°€ ë˜ë©´ ëŒ€í™” ì¢…ë£Œ ì „ëµì„ ì„ íƒí•˜ì—¬ ëŒ€í™”ì˜ ë§ˆë¬´ë¦¬ë¥¼ ì§„í–‰í•˜ì„¸ìš”.
   - ëŒ€í™” ì¢…ë£Œ ì „ëµì„ í†µí•´ ì‚¬ìš©ìì™€ ì¶©ë¶„íˆ ë¬¸ì§„ëŒ€í™”ì˜ ì¢…ë£Œì— ëŒ€í•´ ì´ì•¼ê¸° í•œ í›„ ì‚¬ìš©ìì˜ ë™ì˜ ì˜ì‚¬ë¥¼ ë°›ì€ í›„ ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.
   - ì‚¬ìš©ìê°€ ëŒ€í™” ì¢…ë£Œë¥¼ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ëŒ€í™” ì¢…ë£Œë¥¼ ìœ ë„í•˜ê¸° ë³´ë‹¤ëŠ” ëŒ€í™”ê´€ë¦¬ ì •ì±…ì„ í†µí•´ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”.
   - ë§Œì•½ ëª¨ë“  ë¬¸í•­ì´ ìˆ˜ì§‘ì´ ì•ˆë˜ì—ˆë”ë¼ë„, ì‚¬ìš©ìê°€ ì¢…ë£Œ ì˜ì‚¬ë¥¼ í‘œí˜„í•˜ë©´ ask_completion ì „ëµì„ ì„ íƒí•˜ì—¬ ì‚¬ìš©ìê°€ ì¢…ë£Œë¥¼ ì›í•˜ëŠ” ê²ƒì´ í™•ì‹¤í•œì§€ í™•ì¸í•˜ì„¸ìš”.
   - ì‚¬ìš©ìê°€ ì¢…ë£Œë¥¼ ì›í•˜ëŠ” ê²ƒì´ í™•ì‹¤í•˜ë‹¤ë©´, ë§ˆì§€ë§‰ ì¸ì‚¬ë¥¼ í•˜ê³  ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.
7. ì„¸ì…˜ ê´€ë¦¬ ê°’ ë°˜í™˜ í”„ë¡œí† ì½œ:
    - ì§ˆë¬¸ì€ ì´ 10ê°€ì§€ì…ë‹ˆë‹¤. ëª¨ë“  ë¬¸í•­ì˜ statusê°€ answeredê°€ ë˜ë©´ is_completedë¥¼ trueë¡œ ì„¤ì •í•˜ê³  ë°˜í™˜í•˜ì„¸ìš”. 
    - is_finishedëŠ” ëŒ€í™” ì¢…ë£Œ ì „ëµì„ í†µí•´ ì‚¬ìš©ìì™€ ì¶©ë¶„íˆ ë¬¸ì§„ëŒ€í™”ì˜ ì¢…ë£Œì— ëŒ€í•´ ì´ì•¼ê¸° í•œ í›„ ì‚¬ìš©ìê°€ ëŒ€í™” ì¢…ë£Œ ì˜ì‚¬ë¥¼ ë³´ì˜€ì„ ë•Œ trueë¡œ ì„¤ì •í•˜ì„¸ìš”.
    - ì ˆëŒ€ ì‚¬ìš©ìê°€ ì¢…ë£Œ ì˜ì‚¬ë¥¼ ë³´ì´ì§€ ì•Šì•˜ì„ ë•Œ is_finishedë¥¼ trueë¡œ ì„¤ì •í•˜ì§€ ë§ˆì„¸ìš”.
    - ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì¦ìƒ íƒìƒ‰ ì „ëµì„ ì„ íƒí•œ ê²½ìš°, ë°˜ë“œì‹œ ë¬¼ì–´ë³¼ ì¦ìƒì˜ questionIdë¥¼ ê°™ì´ ë°˜í™˜í•˜ì„¸ìš”. 
8. ëŒ€í™” íë¦„ì˜ ìœ ì—°ì„± ë° ë‹¤ì–‘ì„± ë³´ì¥:
    - ì´ì „ì— ì‚¬ìš©í–ˆë˜ ì •ì±…ì„ ë°”íƒ•ìœ¼ë¡œ, ìƒˆë¡œìš´ ì •ì±…ë“¤ì„ ìš°ì„ ìœ¼ë¡œ ì„ ì •í•˜ì—¬ ì‚¬ìš©ìê°€ í¥ë¯¸ë¥¼ ìƒì§€ ì•Šê³  ëŒ€í™”í•  ìˆ˜ ìˆê²Œ í•˜ì„¸ìš”. 
    - ë‹¤ì–‘í•œ ì ê·¹ì  ê²½ì²­ ì „ëµ ë° ì¦ìƒ íƒìƒ‰ ê¸°ë²•ë“¤ì„ í™œìš©í•˜ì—¬ ëŒ€í™”ë¥¼ ìì—°ìŠ¤ëŸ½ê³  í¥ë¯¸ë¡­ê²Œ ìœ ì§€í•˜ëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”. 
    - ì •ì±…ì€ ë˜ë„ë¡ì´ë©´ í•œ ê°€ì§€ë§Œ ì„ íƒí•˜ë˜, í•„ìš”ì‹œ ë‘ ê°œë¥¼ ì„ íƒí•´ë„ ë©ë‹ˆë‹¤. ë‹¤ë§Œ, ë¬¸ì§„ëŒ€í™” ì±—ë´‡ìœ¼ë¡œì„œ ëŒ€í™”ë¥¼ ì£¼ë„ì ìœ¼ë¡œ ì´ë„ëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”.
9. ëŒ€í™” ìŠ¤íƒ€ì¼ì— ë”°ë¥¸ ì „ëµ ì„ íƒ:
    - ëŒ€í™” ìŠ¤íƒ€ì¼ì´ "ì‹¬ì¸µì ì´ê³  êµ¬ì²´ì ì¸ ëŒ€í™”"ì¸ ê²½ìš°, ì¦ìƒ ìœ ë¬´ë¥¼ ë¬»ê¸° ìœ„í•œ ask_symptom í›„ì— ë§Œì•½ ì¦ìƒì´ ìˆë‹¤ë©´, ê·¸ì— ëŒ€í•œ  ì‹¬ì¸µì ì¸ ì •ë³´ë¥¼ ìƒì„¸í•˜ê²Œ ë¬»ëŠ” ask_condition, ask_frequency ì „ëµì„ ëª¨ë‘ ì„ íƒí•˜ì—¬ ì‚¬ìš©ìì˜ ì¦ìƒì„ ë³´ë‹¤ ì‹¬ì¸µì ìœ¼ë¡œ íŒŒì•…í•˜ì„¸ìš”. 
    - ëŒ€í™” ìŠ¤íƒ€ì¼ì´ "ê°„ê²°í•˜ê³  ì‹ ì†í•œ ëŒ€í™”"ë¼ë©´ ì¦ìƒ ìœ ë¬´ë¥¼ ë¬»ê¸° ìœ„í•œ ask_symptom í›„ì— ë§Œì•½ ì¦ìƒì´ ìˆë‹¤ë©´, ê·¸ê²ƒì— ëŒ€í•œ ask_frequency ì „ëµ ë˜ëŠ” ask_condition ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ë¬¸ì§„ ëŒ€í™”ë¥¼ ì§„í–‰í•˜ì„¸ìš”. 
10. ì •ì±… ì„ íƒ ë¶ˆê°€ ì‹œ:
    - ì£¼ì–´ì§„ ëŒ€í™” ë§¥ë½ê³¼ ë¬¸ì§„ ìƒíƒœë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ„ 1~8ë²ˆì˜ ì–´ë–¤ ì „ëµë„ ì ì ˆí•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨ë  ê²½ìš°, first_policyì— othersë¥¼ ë°˜í™˜í•˜ì„¸ìš”. 
    - ì´ ê²½ìš° second_policyì™€ next_questionì€ nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

DIALOGUE FLOW:
1. ëŒ€í™” ì´ˆê¸° ë‹¨ê³„ì—ì„œëŠ” ë„ì… ë° ë¼í¬í˜•ì„± ì „ëµê³¼ ëŒ€í™” ê°œì¸í™” ì „ëµì„ ì„ íƒí•˜ì„¸ìš”. íŠ¹íˆ, ëŒ€í™” ê°œì¸í™” ì „ëµì€ ë°˜ë“œì‹œ ì´ˆë°˜ì— ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
2. ëŒ€í™” ì¤‘ê°„ ë‹¨ê³„ì—ì„œëŠ” ì¦ìƒ íƒìƒ‰ ì „ëµê³¼ ì ê·¹ì  ê²½ì²­ ì „ëµì„ ì„ íƒí•˜ì—¬ ë¬¸ì§„ ëŒ€í™”ì— ì§‘ì¤‘í•˜ì„¸ìš”. ì‚¬ìš©ìì˜ ì‘ë‹µì— ë”°ë¼ ëŒ€í™” ê´€ë¦¬ ì „ëµì„ ì„ íƒí•˜ì—¬ ëŒ€í™” íë¦„ì„ ë§¤ë„ëŸ½ê²Œ ìœ ì§€í•˜ì„¸ìš”.
3. ëŒ€í™” ë§ˆë¬´ë¦¬ ë‹¨ê³„ëŠ” ëª¨ë“  ë¬¸ì§„ ëŒ€í™” ë¬¸í•­ì˜ ìƒíƒœê°€ answeredê°€ ë˜ê±°ë‚˜ ì‚¬ìš©ìê°€ ëŒ€í™”ë¥¼ ì¢…ë£Œ ì˜ì‚¬ë¥¼ ë³´ì˜€ì„ ë•Œ ì‹¤í–‰í•˜ì„¸ìš”. 
4. í˜„ì¬ ë¦¬ìŠ¤íŠ¸ëœ ì „ëµìœ¼ë¡œëŠ” ëŒ€í™”ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ëŒì–´ê°ˆ ìˆ˜ ì—†ë‹¤ê³  íŒë‹¨í•œ ê²½ìš°, first_policyì— othersë¥¼ ì¶œë ¥í•˜ì„¸ìš”. 

JSON í˜•íƒœë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:
{
  "first_policy": "ì„ íƒëœ ì²« ë²ˆì§¸ ì •ì±…",
  "second_policy": "ì„ íƒëœ ë‘ ë²ˆì§¸ ì •ì±… ë˜ëŠ” null",
  "next_question": "ì„ íƒëœ ë¬¸í•­ì˜ questionId, ì¦ìƒ íƒìƒ‰ ì •ì±…ì´ ì—†ë‹¤ë©´ null",
  "is_completed": "ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ ì—¬ë¶€, true ë˜ëŠ” false",
  "is_finished": "ëŒ€í™” ì¢…ë£Œ ì—¬ë¶€, true ë˜ëŠ” false"
}
"""


def select_policy(intent, user_message, history, client, message_count, updated_status=None, selected_policies=None, conversation_style=None):
    """NLU ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€í™” ì •ì±…ì„ ì„ íƒí•˜ëŠ” í•¨ìˆ˜"""
    ai_logger.info("ğŸ¯ ì •ì±… ì„ íƒ ì¤‘...")
    intent = intent.get('intent', 'unknown')
    
    # ì´ì „ì— ì„ íƒëœ ì •ì±…ë“¤ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
    policies_history = ""
    if selected_policies:
        policies_history = f"\nì´ì „ì— ì„ íƒëœ ì •ì±…ë“¤: {', '.join(selected_policies)}"
        ai_logger.info(f"ğŸ“‹ ì´ì „ ì •ì±… ì„ íƒ ì´ë ¥: {', '.join(selected_policies)}")
    
    context_text = f"í˜„ì¬ ìƒíƒœ:{updated_status}\nëŒ€í™” íˆìŠ¤í† ë¦¬:\n{history}\ní˜„ì¬ ì‚¬ìš©ì ë©”ì‹œì§€: {user_message}\nì˜ë„ ë¶„ì„ ê²°ê³¼:{intent}\nì´ì „ ëŒ€í™” ì •ì±…:{policies_history}\nëŒ€í™” ìŠ¤íƒ€ì¼:{conversation_style}"
    
    messages = [
        {"role": "system", "content": POLICY_SELECTION_PROMPT},
        {"role": "user", "content": context_text}
    ]
    
    max_retries = 3
    retry_delay = 1  # ì´ˆ
    
    for attempt in range(max_retries):
        try:
            if attempt > 0:
                ai_logger.info(f"ğŸ”„ ì •ì±… ì„ íƒ ì¬ì‹œë„ {attempt}/{max_retries}")
                time.sleep(retry_delay * attempt)  # ì¬ì‹œë„ ì‹œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
            
            log_api_call("gpt-5-chat-latest", "policy_selection", attempt + 1)
            response = client.chat.completions.create(
                model="gpt-5-chat-latest",
                messages=messages,
                max_tokens=50,
                temperature=0.5
            )
            
            result_text = response.choices[0].message.content.strip()        
            policy_result = json.loads(result_text)
            
            # ì„ íƒëœ ì •ì±…ë“¤ì„ ì¶”ì¶œí•˜ì—¬ ë¡œê¹…
            selected_policies_list = []
            if policy_result.get('first_policy'):
                selected_policies_list.append(policy_result['first_policy'])
            if policy_result.get('second_policy'):
                selected_policies_list.append(policy_result['second_policy'])
            
            ai_logger.info(f"ğŸ“Š ì •ì±… ì„ íƒ ê²°ê³¼: {policy_result}")
            ai_logger.info(f"ğŸ¯ ì´ë²ˆì— ì„ íƒëœ ì •ì±…ë“¤: {', '.join(selected_policies_list) if selected_policies_list else 'ì—†ìŒ'}")
            ai_logger.info("----------------------------------------------------------")
            return policy_result
            
        except Exception as e:
            ai_logger.warning(f"âš ï¸ ì •ì±… ì„ íƒ ì‹œë„ {attempt + 1} ì‹¤íŒ¨: {str(e)}")
            if attempt == max_retries - 1:
                log_error("ì •ì±… ì„ íƒ ìµœì¢… ì‹¤íŒ¨", e)
                return {
                    "first_policy": "failed",
                    "second_policy": "failed",
                    "next_question": "failed",
                    "reason": "failed"
                }
            continue